import os

from .attckdocs import AttckDocs

class MalwareDocs(AttckDocs):

    def __init__(self, folder):
        self.folder = os.path.abspath(folder)
        if not os.path.exists(self.folder):
            os.mkdir(self.folder)
        if not os.path.exists(os.path.join(self.folder, 'malwares')):
            os.mkdir(os.path.join(self.folder, 'malwares'))

        self.folder = os.path.join(self.folder, 'malwares')

    def go(self):
        for malware in self._attck.enterprise.malwares:
            markdown = None
            alias = None
            if hasattr(malware, 'alias'):
                if malware.alias:
                    alias = malware.alias
            markdown = '''
# {name}

## Description

### MITRE Description

> {description}

## Aliases

```
{alias}
```

## Platforms

```
{platforms}
``
'''.format(
    name=malware.name,
    description=malware.description,
    alias='' if not alias else '\n'.join([str(x) for x in alias]),
    platforms=malware.platforms
)
            technique_list = None
            for technique in malware.techniques:
                if technique_list is None:
                    technique_list = '''
* [{name}](../techniques/{id}.md)
'''.format(name=technique.name, id=technique.name.replace(' ', '-').replace('/','-'))
                else:
                    technique_list += '''
* [{name}](../techniques/{id}.md)
    '''.format(name=technique.name, id=technique.name.replace(' ', '-').replace('/','-'))

            markdown += '''
# Techniques

{technique_list}
'''.format(technique_list=technique_list)

            actor_list = None
            for actor in malware.actors:
                if actor_list is None:
                    actor_list = '''
* [{name}](../actors/{id}.md)
'''.format(name=actor.name, id=actor.name.replace(' ', '-').replace('/','-'))
                else:
                    actor_list += '''
* [{name}](../actors/{id}.md)
    '''.format(name=actor.name, id=actor.name.replace(' ', '-').replace('/','-'))

            markdown += '''
# Actors

{actor_list}
'''.format(actor_list=actor_list)

            with open('{folder}/{name}.md'.format(folder=self.folder, name=malware.name.replace(' ', '-').replace('/','-')), 'w+') as f:
                f.write(markdown)
